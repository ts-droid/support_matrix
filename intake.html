<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brand Intake Form | Support Matrix</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f7f7f7;
        --ink: #000000;
        --ink-muted: #666666;
        --accent: #df3314;
        --line: #e2e2e2;
        --surface: #ffffff;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Avenir Next", Avenir, "Open Sans", Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: var(--ink);
      }

      main {
        width: min(860px, calc(100% - 2rem));
        margin: 2rem auto;
      }

      .card {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 1rem;
      }

      .top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .lang-switch {
        display: inline-flex;
        gap: 0.4rem;
      }

      .lang-btn {
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #fff;
        color: #000;
        padding: 0.45rem 0.65rem;
        font-size: 0.82rem;
        cursor: pointer;
      }

      .lang-btn.active {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }

      h1,
      h2 {
        margin: 0;
      }

      p {
        color: var(--ink-muted);
      }

      form {
        display: grid;
        gap: 0.75rem;
      }

      .grid {
        display: grid;
        gap: 0.75rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      label {
        display: grid;
        gap: 0.35rem;
        font-size: 0.9rem;
      }

      input,
      select,
      textarea,
      button {
        font: inherit;
      }

      input,
      select,
      textarea {
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 0.62rem 0.7rem;
        background: #fff;
      }

      textarea {
        min-height: 120px;
      }

      button {
        border: 0;
        border-radius: 10px;
        padding: 0.7rem 1rem;
        font-weight: 700;
        color: #fff;
        background: var(--accent);
        cursor: pointer;
      }

      .status {
        min-height: 1.2rem;
        margin: 0;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        margin-top: 0.25rem;
      }

      .ghost {
        border: 1px solid var(--line);
        background: #fff;
        color: var(--ink);
      }

      #csvFile {
        display: none;
      }

      .hint {
        font-size: 0.9rem;
        color: var(--ink-muted);
        margin-top: 0.2rem;
      }
    </style>
  </head>
  <body>
    <main>
      <section class="card">
        <div class="top">
          <h1 data-i18n="title">Brand Intake Form</h1>
          <div class="lang-switch" role="group" aria-label="Language switch">
            <button type="button" id="langSv" class="lang-btn">ðŸ‡¸ðŸ‡ª Svenska</button>
            <button type="button" id="langEn" class="lang-btn">ðŸ‡¬ðŸ‡§ English</button>
          </div>
        </div>
        <p data-i18n="intro">
          Please provide the required support handling details. Once submitted, the data is automatically
          synced into our Support Matrix decision flow.
        </p>

        <h2 style="margin-top: 1rem" data-i18n="csvTitle">Bulk CSV Import</h2>
        <p data-i18n="csvDesc"></p>
        <div class="actions">
          <button type="button" id="downloadCsvTemplate" class="ghost" data-i18n="downloadCsv">Download CSV Template</button>
          <label class="ghost" for="csvFile" style="display: inline-flex; align-items: center; cursor: pointer; border-radius: 10px; padding: 0.7rem 1rem;" data-i18n="uploadCsv">Upload CSV</label>
          <input id="csvFile" type="file" accept=".csv,text/csv" />
        </div>
        <p class="hint" data-i18n="csvHint"></p>
        <p class="status" id="csvStatus" aria-live="polite"></p>

        <form id="intakeForm">
          <div class="grid">
            <label>
              <span data-i18n="supplierName">Supplier name *</span>
              <input name="supplierName" required />
            </label>
            <label>
              <span data-i18n="supplierEmail">Supplier contact email</span>
              <input name="supplierEmail" type="email" />
            </label>
            <label>
              <span data-i18n="brandName">Brand name *</span>
              <input name="brandName" required />
            </label>
            <label>
              <span data-i18n="categoryName">Product category *</span>
              <input name="categoryName" required />
            </label>
            <label>
              <span data-i18n="caseType">Case type</span>
              <select name="caseType" id="caseTypeSelect"></select>
            </label>
            <label>
              <span data-i18n="customerType">Customer type</span>
              <select name="customerType" id="customerTypeSelect"></select>
            </label>
            <label>
              <span data-i18n="headline">Handling headline *</span>
              <input name="headline" id="headlineInput" required />
            </label>
            <label>
              <span data-i18n="responsible">Responsible team</span>
              <input name="responsible" id="responsibleInput" />
            </label>
            <label>
              <span data-i18n="sla">SLA</span>
              <input name="sla" id="slaInput" />
            </label>
          </div>

          <label>
            <span data-i18n="instructions">Handling instructions * (one line per step)</span>
            <textarea name="instructions" required></textarea>
          </label>

          <label>
            <span data-i18n="supplierNotes">Supplier notes</span>
            <textarea name="supplierNotes" id="supplierNotesInput"></textarea>
          </label>

          <button type="submit" data-i18n="submitBtn">Submit Intake</button>
          <p class="status" id="status" aria-live="polite"></p>
        </form>
      </section>
    </main>

    <script>
      const LANG_KEY = "support-matrix-lang";
      const I18N = {
        en: {
          title: "Brand Intake Form",
          intro:
            "Please provide the required support handling details. Once submitted, the data is automatically synced into our Support Matrix decision flow.",
          csvTitle: "Bulk CSV Import",
          csvDesc:
            "For multiple flows at once, use a CSV file. One row can include multiple categories in categoryNames separated by | (example: Laptop|Monitor|Docking).",
          csvHint:
            "CSV columns: supplierName, supplierEmail, supplierNotes, brandName, categoryNames, caseType, customerType, headline, instructions, responsible, sla",
          downloadCsv: "Download CSV Template",
          uploadCsv: "Upload CSV",
          supplierName: "Supplier name *",
          supplierEmail: "Supplier contact email",
          brandName: "Brand name *",
          categoryName: "Product category *",
          caseType: "Case type",
          customerType: "Customer type",
          headline: "Handling headline *",
          responsible: "Responsible team",
          sla: "SLA",
          instructions: "Handling instructions * (one line per step)",
          supplierNotes: "Supplier notes",
          submitBtn: "Submit Intake",
          caseOptions: {
            all: "All case types",
            doa: "DOA",
            warranty: "Warranty after usage",
          },
          customerOptions: {
            all: "All customer types",
            private: "Private",
            b2b: "Business to business",
          },
          phHeadline: "Example: DOA replacement via supplier RMA",
          phResponsible: "Example: First line + Supplier",
          phSla: "Example: Response in 24h",
          phSupplierNotes: "Optional notes for return logistics or conditions",
          submitting: "Submitting...",
          submitOk: "Submitted successfully. Your data is now available in the Support Matrix.",
          submitFail: "Could not submit: {error}",
          csvTemplateDone: "CSV template downloaded.",
          csvUploading: "Uploading CSV...",
          csvOk:
            "CSV imported: {rules} rules, {suppliers} suppliers, {brands} brands, {categories} categories. Skipped rows: {skipped}.",
          csvFail: "Could not import CSV: {error}",
        },
        sv: {
          title: "VarumÃ¤rkesformulÃ¤r",
          intro:
            "Fyll i nÃ¶dvÃ¤ndig information fÃ¶r supporthantering. NÃ¤r formulÃ¤ret skickas in synkas datan automatiskt till vÃ¥rt Support Matrix-flÃ¶de.",
          csvTitle: "CSV massimport",
          csvDesc:
            "FÃ¶r flera flÃ¶den samtidigt, anvÃ¤nd en CSV-fil. En rad kan innehÃ¥lla flera kategorier i categoryNames separerat med | (exempel: Laptop|Monitor|Docking).",
          csvHint:
            "CSV-kolumner: supplierName, supplierEmail, supplierNotes, brandName, categoryNames, caseType, customerType, headline, instructions, responsible, sla",
          downloadCsv: "Ladda ner CSV-mall",
          uploadCsv: "Ladda upp CSV",
          supplierName: "LeverantÃ¶rsnamn *",
          supplierEmail: "LeverantÃ¶rens e-post",
          brandName: "VarumÃ¤rke *",
          categoryName: "Produktkategori *",
          caseType: "Ã„rendetyp",
          customerType: "Kundtyp",
          headline: "Rubrik fÃ¶r hantering *",
          responsible: "Ansvarigt team",
          sla: "SLA",
          instructions: "Instruktioner * (en rad per steg)",
          supplierNotes: "LeverantÃ¶rsnoteringar",
          submitBtn: "Skicka formulÃ¤r",
          caseOptions: {
            all: "Alla Ã¤rendetyper",
            doa: "DOA",
            warranty: "Garanti efter anvÃ¤ndning",
          },
          customerOptions: {
            all: "Alla kundtyper",
            private: "Privat",
            b2b: "Business to business",
          },
          phHeadline: "Exempel: DOA-utbyte via leverantÃ¶rens RMA",
          phResponsible: "Exempel: FÃ¶rsta linjen + LeverantÃ¶r",
          phSla: "Exempel: Svar inom 24h",
          phSupplierNotes: "Valfria noteringar fÃ¶r returlogistik eller villkor",
          submitting: "Skickar...",
          submitOk: "Inskickat. Datan finns nu tillgÃ¤nglig i Support Matrix.",
          submitFail: "Kunde inte skicka: {error}",
          csvTemplateDone: "CSV-mall nedladdad.",
          csvUploading: "Laddar upp CSV...",
          csvOk:
            "CSV importerad: {rules} regler, {suppliers} leverantÃ¶rer, {brands} varumÃ¤rken, {categories} kategorier. Skippade rader: {skipped}.",
          csvFail: "Kunde inte importera CSV: {error}",
        },
      };

      let currentLang = localStorage.getItem(LANG_KEY) === "sv" ? "sv" : "en";

      const form = document.getElementById("intakeForm");
      const statusEl = document.getElementById("status");
      const csvStatusEl = document.getElementById("csvStatus");

      function t(key) {
        return I18N[currentLang][key] || key;
      }

      function fmt(key, vars = {}) {
        return Object.entries(vars).reduce((acc, [name, value]) => acc.replaceAll(`{${name}}`, String(value)), t(key));
      }

      function optionHtml(value, label) {
        return `<option value="${value}">${label}</option>`;
      }

      function applyLang() {
        document.documentElement.lang = currentLang;
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          el.textContent = t(el.dataset.i18n);
        });

        document.getElementById("headlineInput").placeholder = t("phHeadline");
        document.getElementById("responsibleInput").placeholder = t("phResponsible");
        document.getElementById("slaInput").placeholder = t("phSla");
        document.getElementById("supplierNotesInput").placeholder = t("phSupplierNotes");

        document.getElementById("caseTypeSelect").innerHTML = ["all", "doa", "warranty"]
          .map((id) => optionHtml(id, I18N[currentLang].caseOptions[id]))
          .join("");

        document.getElementById("customerTypeSelect").innerHTML = ["all", "private", "b2b"]
          .map((id) => optionHtml(id, I18N[currentLang].customerOptions[id]))
          .join("");

        document.getElementById("langSv").classList.toggle("active", currentLang === "sv");
        document.getElementById("langEn").classList.toggle("active", currentLang === "en");
      }

      function setLang(lang) {
        currentLang = lang === "sv" ? "sv" : "en";
        localStorage.setItem(LANG_KEY, currentLang);
        applyLang();
      }

      function downloadCsvTemplate() {
        const header =
          "supplierName,supplierEmail,supplierNotes,brandName,categoryNames,caseType,customerType,headline,instructions,responsible,sla";
        const sample =
          '"Nordic Supply AB","support@nordicsupply.se","Returns via portal","AeroHome","Robotdammsugare|Skarm","doa","private","DOA replacement process","Validate defect||Create return label||Ship replacement","1st line + Warehouse","Response 4h / replacement 24h"';
        const payload = `${header}\n${sample}\n`;
        const blob = new Blob([payload], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "support-matrix-template.csv";
        a.click();
        URL.revokeObjectURL(url);
        csvStatusEl.textContent = t("csvTemplateDone");
        csvStatusEl.style.color = "#4f5a66";
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        statusEl.textContent = t("submitting");
        statusEl.style.color = "#4f5a66";

        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());

        try {
          const response = await fetch("/api/intake", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.error || "Submission failed");

          statusEl.textContent = t("submitOk");
          statusEl.style.color = "#067647";
          form.reset();
          applyLang();
        } catch (error) {
          statusEl.textContent = fmt("submitFail", { error: error.message });
          statusEl.style.color = "#b42318";
        }
      });

      document.getElementById("downloadCsvTemplate").addEventListener("click", downloadCsvTemplate);

      document.getElementById("csvFile").addEventListener("change", async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;

        csvStatusEl.textContent = t("csvUploading");
        csvStatusEl.style.color = "#4f5a66";

        try {
          const csvText = await file.text();
          const response = await fetch("/api/intake/csv", {
            method: "POST",
            headers: { "Content-Type": "text/csv" },
            body: csvText,
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.error || "CSV import failed");

          csvStatusEl.textContent = fmt("csvOk", {
            rules: result.createdRules,
            suppliers: result.createdSuppliers,
            brands: result.createdBrands,
            categories: result.createdCategories,
            skipped: result.skippedRows,
          });
          csvStatusEl.style.color = "#067647";
        } catch (error) {
          csvStatusEl.textContent = fmt("csvFail", { error: error.message });
          csvStatusEl.style.color = "#b42318";
        } finally {
          event.target.value = "";
        }
      });

      document.getElementById("langSv").addEventListener("click", () => setLang("sv"));
      document.getElementById("langEn").addEventListener("click", () => setLang("en"));

      applyLang();
    </script>
  </body>
</html>
